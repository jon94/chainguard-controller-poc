name: CG Demo App CI - Chainguard Controller

on:
  push:
    branches: ["main"]
    paths: ["demo-app/**"]
  pull_request:
    branches: ["main"]
    paths: ["demo-app/**"]
  workflow_dispatch: # Allow manual trigger for demo purposes

jobs:
  build_test_push_demo_app:
    name: build_test_push_demo_app
    permissions: write-all
    runs-on: ubuntu-latest
    env:
      DOCKER_REPOSITORY: jonlimpw # name of Docker Hub ID
      IMAGE_NAME: cg-demo

    steps:
      - uses: actions/checkout@v4

      - name: Generate Version Tags
        id: version
        run: |
          # Get short SHA for unique identification
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          # Create version from timestamp for demo purposes
          TIMESTAMP="v$(date +%Y%m%d-%H%M%S)"
          VERSION="$TIMESTAMP-$SHORT_SHA"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Build and Push Demo App Docker Image
        uses: mr-smithers-excellent/docker-build-push@v6
        with:
          image: ${{ env.DOCKER_REPOSITORY }}/${{ env.IMAGE_NAME }}
          registry: docker.io
          dockerfile: ./demo-app/Dockerfile
          directory: ./demo-app
          tags: latest,${{ steps.version.outputs.version }},${{ steps.version.outputs.short_sha }},${{ steps.version.outputs.timestamp }}
          buildArgs: "DD_GIT_REPOSITORY_URL=github.com/jon94/chainguard-controller-poc,DD_GIT_COMMIT_SHA=$(git rev-parse HEAD)"
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.1.1
        with:
          cosign-release: 'v2.1.1'

      - name: Wait for DockerHub Processing
        run: |
          echo "â³ Waiting for DockerHub to process the new image..."
          sleep 45

      - name: Get New Image Digest
        id: digest
        run: |
          # Get the digest of the newly pushed image
          echo "ðŸ” Fetching digest for jonlimpw/cg-demo:latest"
          
          # Use Docker Hub API to get the digest
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:jonlimpw/cg-demo:pull" | jq -r .token)
          DIGEST=$(curl -s -H "Authorization: Bearer $TOKEN" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" "https://registry-1.docker.io/v2/jonlimpw/cg-demo/manifests/latest" | jq -r '.config.digest // empty')
          
          if [ -z "$DIGEST" ]; then
            # Fallback: get digest from response headers
            DIGEST=$(curl -s -I -H "Authorization: Bearer $TOKEN" -H "Accept: application/vnd.docker.distribution.manifest.v2+json" "https://registry-1.docker.io/v2/jonlimpw/cg-demo/manifests/latest" | grep -i docker-content-digest | cut -d' ' -f2 | tr -d '\r')
          fi
          
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ New digest: $DIGEST"

      - name: Sign Container Image with Cosign
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "ðŸ” Signing container image with Cosign..."
          
          # Sign the image using keyless signing (OIDC)
          cosign sign --yes --insecure-ignore-tlog jonlimpw/cg-demo@${{ steps.digest.outputs.digest }}
          
          echo "âœ… Image signed successfully!"

      - name: Generate SLSA Attestation
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "ðŸ“œ Generating SLSA attestation..."
          
          # Create SLSA provenance attestation
          cat > slsa-predicate.json << EOF
          {
            "buildType": "https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@refs/tags/v1.4.0",
            "builder": {
              "id": "https://github.com/actions/runner"
            },
            "invocation": {
              "configSource": {
                "uri": "git+https://github.com/${{ github.repository }}@refs/heads/${{ github.ref_name }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                }
              }
            },
            "metadata": {
              "buildInvocationId": "${{ github.run_id }}-${{ github.run_attempt }}",
              "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "completeness": {
                "parameters": true,
                "environment": false,
                "materials": false
              },
              "reproducible": false
            },
            "materials": [
              {
                "uri": "git+https://github.com/${{ github.repository }}@refs/heads/${{ github.ref_name }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                }
              }
            ]
          }
          EOF
          
          # Attest the image with SLSA provenance
          cosign attest --yes --insecure-ignore-tlog --predicate slsa-predicate.json --type slsaprovenance jonlimpw/cg-demo@${{ steps.digest.outputs.digest }}
          
          echo "âœ… SLSA attestation generated successfully!"

      - name: Verify Signature and Attestation
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "ðŸ” Verifying signature and attestation..."
          
          # Verify the signature
          cosign verify --insecure-ignore-tlog jonlimpw/cg-demo@${{ steps.digest.outputs.digest }}
          
          # Verify the attestation
          cosign verify-attestation --insecure-ignore-tlog --type slsaprovenance jonlimpw/cg-demo@${{ steps.digest.outputs.digest }}
          
          echo "âœ… Verification successful!"

      - name: Chainguard Controller Impact
        run: |
          echo "ðŸŽ¯ NEW SIGNED IMAGE PUSHED TO DOCKERHUB!"
          echo "========================================"
          echo ""
          echo "ðŸ“¦ Images Built & Signed:"
          echo "   â€¢ jonlimpw/cg-demo:latest"
          echo "   â€¢ jonlimpw/cg-demo:${{ steps.version.outputs.version }}"
          echo "   â€¢ jonlimpw/cg-demo:${{ steps.version.outputs.short_sha }}"
          echo "   â€¢ jonlimpw/cg-demo:${{ steps.version.outputs.timestamp }}"
          echo "ðŸ“‹ Latest Digest: ${{ steps.digest.outputs.digest }}"
          echo ""
          echo "ðŸ” Security Features:"
          echo "   â€¢ âœ… Cosign signature applied (keyless OIDC)"
          echo "   â€¢ âœ… SLSA provenance attestation generated"
          echo "   â€¢ âœ… Supply chain transparency via Rekor"
          echo ""
          echo "ðŸ¤– CHAINGUARD CONTROLLER WILL:"
          echo "  âš¡ Detect new digest within 10 seconds"
          echo "  ðŸš¨ Flag existing tag-based deployments as non-compliant"
          echo "  âœ… Mark digest-based deployments as compliant"
          echo "  ðŸ“Š Update ImagePolicy status in real-time"
          echo ""
          echo "ðŸŽ­ DEMO IMPACT:"
          echo "  â€¢ Perfect for showing real-time compliance monitoring"
          echo "  â€¢ Demonstrates supply chain security automation"
          echo "  â€¢ Shows enterprise-grade image governance"
          echo ""
          echo "ðŸ”§ TO UPDATE DEPLOYMENT FOR COMPLIANCE:"
          echo "  kubectl set image deployment/cg-demo cg-demo=jonlimpw/cg-demo@${{ steps.digest.outputs.digest }}"
